<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Scanner</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f3f6fb; color:#222; margin:0; padding:40px; }
    main { max-width:1000px; margin:auto; background:#fff; padding:24px 32px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.05); }
    h1 { text-align:center; color:#007bff; margin-top:0; }
    #form { display:flex; flex-wrap:wrap; gap:16px; justify-content:space-between; }
    label { flex:1 1 200px; font-size:14px; }
    input { width:100%; padding:8px; margin-top:4px; border:1px solid #ccc; border-radius:6px; }
    .actions { flex:1 1 100%; display:flex; gap:10px; justify-content:center; margin-top:8px; }
    button { padding:10px 16px; border:none; border-radius:8px; background:#007bff; color:#fff; cursor:pointer; transition:0.2s; }
    button:hover:not(:disabled){ background:#005ec4; }
    button:disabled{ opacity:0.6; cursor:not-allowed; }
    #status { margin-top:12px; text-align:center; font-weight:500; }
    table { width:100%; border-collapse:collapse; margin-top:20px; font-size:14px; }
    th, td { border:1px solid #eee; padding:8px 10px; text-align:left; }
    th { background:#f9fafb; }
    td a { color:#007bff; text-decoration:none; }
    td a:hover { text-decoration:underline; }
    .caption { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:250px; }
    @media(max-width:700px){
      #form{flex-direction:column;}
      label{width:100%;}
    }
  </style>
</head>
<body>
  <main>
    <h1>üé¨ TikTok Scanner</h1>
    <div id="form">
      <label>Username:<input id="username" placeholder="vd: tiktokvn" /></label>
      <label>S·ªë l∆∞·ª£ng video:<input id="limit" type="number" value="30" min="1" /></label>
      <label>T·ª´ ng√†y:<input id="start" type="date" /></label>
      <label>ƒê·∫øn ng√†y:<input id="end" type="date" /></label>
      <div class="actions">
        <button id="fetchBtn">B·∫Øt ƒë·∫ßu qu√©t</button>
        <button id="downloadCsvBtn" disabled>T·∫£i CSV</button>
        <button id="downloadXlsxBtn" disabled>T·∫£i XLSX</button>
      </div>
    </div>

    <div id="status"></div>
    <div id="output"></div>
  </main>

  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  const WORKER_URL = "https://tiktok-proxy.thanhnhut201294.workers.dev/";

  function formatDate(tsSeconds) {
    return new Date(tsSeconds * 1000).toLocaleString();
  }

  async function fetchViaWorker(username, cursor, count) {
    const url = new URL(WORKER_URL);
    url.searchParams.set('unique_id', username);
    url.searchParams.set('count', count);
    if (cursor) url.searchParams.set('cursor', cursor);
    const res = await fetch(url.toString());
    if (!res.ok) throw new Error('Network error: ' + res.status);
    return res.json();
  }

  async function fetchTikTokVideos(username, maxVideos, startDate, endDate) {
    const allVideos = [];
    const processedIds = new Set();
    let cursor = 0, hasMore = true;
    const countPerRequest = 30;

    while (hasMore) {
      const data = await fetchViaWorker(username, cursor, countPerRequest);
      if (!data?.data?.videos) throw new Error('L·ªói API ho·∫∑c kh√¥ng c√≥ videos');
      for (const v of data.data.videos) {
        if (!v.video_id || processedIds.has(v.video_id)) continue;
        const postDate = new Date(v.create_time * 1000);
        if (startDate && endDate && (postDate < startDate || postDate > endDate)) continue;
        if (allVideos.length >= maxVideos) { hasMore = false; break; }
        allVideos.push(v);
        processedIds.add(v.video_id);
      }
      cursor = data.data.sec_cursor || data.data.cursor || null;
      if (!cursor || allVideos.length >= maxVideos) hasMore = false;
      else await new Promise(r => setTimeout(r, 400));
    }
    return allVideos;
  }

  document.getElementById('fetchBtn').addEventListener('click', async () => {
    const username = document.getElementById('username').value.trim();
    const limit = parseInt(document.getElementById('limit').value);
    const start = document.getElementById('start').value ? new Date(document.getElementById('start').value) : null;
    const end = document.getElementById('end').value ? new Date(document.getElementById('end').value) : null;
    const status = document.getElementById('status');
    const output = document.getElementById('output');
    document.getElementById('downloadCsvBtn').disabled = true;
    document.getElementById('downloadXlsxBtn').disabled = true;
    output.innerHTML = '';

    if (!username || !limit) { alert('Nh·∫≠p username v√† s·ªë l∆∞·ª£ng!'); return; }
    status.textContent = '‚è≥ ƒêang t·∫£i...';

    try {
      const videos = await fetchTikTokVideos(username, limit, start, end);
      status.textContent = `‚úÖ ƒê√£ l·∫•y ${videos.length} video.`;
      renderTable(videos, username);
      prepareDownloads(videos, username);
    } catch (e) {
      status.textContent = '‚ùå ' + e.message;
    }
  });

  function renderTable(videos, username) {
    const output = document.getElementById('output');
    const table = document.createElement('table');
    table.innerHTML = `
      <tr>
        <th>STT</th>
        <th>Video URL</th>
        <th>Caption</th>
        <th>Ng√†y ƒëƒÉng</th>
        <th>Views</th>
        <th>Likes</th>
        <th>Comments</th>
        <th>Shares</th>
      </tr>`;
    videos.forEach((v, i) => {
      const caption = v.title || '(Kh√¥ng c√≥ caption)';
      const short = caption.length > 80 ? caption.slice(0, 80) + '...' : caption;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td><a href="https://www.tiktok.com/@${username}/video/${v.video_id}" target="_blank">Xem</a></td>
        <td class="caption" title="${escapeHtml(caption)}">${escapeHtml(short)}</td>
        <td>${formatDate(v.create_time)}</td>
        <td>${v.play_count || 0}</td>
        <td>${v.digg_count || 0}</td>
        <td>${v.comment_count || 0}</td>
        <td>${v.share_count || 0}</td>`;
      table.appendChild(tr);
    });
    output.innerHTML = '';
    output.appendChild(table);
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function prepareDownloads(videos, username) {
    if (!videos.length) return;
    const headers = ['STT','VideoURL','Caption','Date','Views','Likes','Comments','Shares'];
    const rows = videos.map((v, i) => [
      i + 1,
      `https://www.tiktok.com/@${username}/video/${v.video_id}`,
      v.title || '',
      formatDate(v.create_time),
      v.play_count || 0, v.digg_count || 0, v.comment_count || 0, v.share_count || 0
    ]);

    // CSV
    const csvContent = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const csvUrl = URL.createObjectURL(blob);
    const csvBtn = document.getElementById('downloadCsvBtn');
    csvBtn.href = csvUrl;
    csvBtn.download = `tiktok_${username}.csv`;
    csvBtn.disabled = false;
    csvBtn.onclick = () => setTimeout(() => URL.revokeObjectURL(csvUrl), 1000);

    // XLSX
    const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'TikTok');
    const xlsxBtn = document.getElementById('downloadXlsxBtn');
    xlsxBtn.onclick = () => XLSX.writeFile(wb, `tiktok_${username}.xlsx`);
    xlsxBtn.disabled = false;
  }
  </script>
</body>
</html>
